#!/bin/sh

#link latest src image
TMP=$(ls -t ./opinsys/*.img|head -n1)
SRC=$(basename $TMP)
if test -h ./images/image.img;then
    rm ./images/image.img
fi
ln -s $(readlink -e ./opinsys/$SRC) ./images/image.img

cd ./images

#mount image
puavo-img-mount image.img

#copy data to image
cp -r  ../cache   ./image/var/
cp -r  ../install ./image/


#patch!
#echo "/install/bin/puavo-img-chroot-apply" | puavo-dir-chroot ./image

#cache debs
rsync -rav  --delete --size-only  ./image/var/cache/apt/archives/ ../cache/apt/archives/

#clean image
rm -r ./image/install
rm -r ./image/var/cache/apt/archives/*

#compose new image name
VERSION==$(date +%Y-%m-%d-%H%M%S)
IMAGE="puavo-os-${CLASS}-${DIST}-${VERSION}-amd64"

#save names in image
echo "${IMAGE}.img" > ./image/etc/puavo-image/name
echo "$( cat ./image/etc/puavo-image/release ) (${VERSION})">./image/etc/puavo-image/release
echo "$CLASS" > ./image/etc/puavo-image/class

#make compressed image
puavo-dir-clone --dont-update-name --type squashfs ./image ${IMGAGE}.img

#umount
puavo-img-mount --umount image.img

	
